<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Heritage Property Conditions Assessment - Checklist 1.1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.5;
            color: #333;
            background: #f5f5f5;
            padding: 15px;
            -webkit-font-smoothing: antialiased;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        /* Save indicator */
        .save-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 1000;
            font-size: 11px;
        }
        
        .save-indicator.saving { background: #fff3cd; border: 2px solid #ffc107; }
        .save-indicator.saved { background: #d4edda; border: 2px solid #28a745; }
        
        .save-indicator .icon {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }
        
        .save-indicator.saving .icon {
            border: 2px solid #ffc107;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        
        .save-indicator.saved .icon {
            background: #28a745;
            color: white;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 22px;
            text-transform: uppercase;
            border-bottom: 3px solid #3498db;
            padding-bottom: 12px;
        }
        
        h2 {
            color: #2c3e50;
            margin-top: 25px;
            margin-bottom: 12px;
            font-size: 17px;
            background: #ecf0f1;
            padding: 10px 12px;
            border-left: 4px solid #3498db;
        }
        
        h3 {
            color: #34495e;
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 15px;
            font-weight: 600;
        }
        
        .form-section {
            margin-bottom: 25px;
        }
        
        .room-section, .facade-section, .summary-section {
            padding-top: 15px;
            border-top: 3px solid #3498db;
            margin-top: 30px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .remove-section-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            -webkit-appearance: none;
        }
        
        .add-section-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin: 15px 0;
            width: 100%;
            font-size: 15px;
            -webkit-appearance: none;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        input[type="text"],
        input[type="date"],
        input[type="email"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            font-family: inherit;
            -webkit-appearance: none;
        }
        
        textarea {
            min-height: 90px;
            resize: vertical;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .checkbox-group, .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }
        
        .checkbox-item, .radio-item {
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 40px;
        }
        
        input[type="checkbox"], input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* Photo upload */
        .photo-upload {
            border: 3px dashed #3498db;
            border-radius: 8px;
            padding: 18px;
            text-align: center;
            background: #f8f9fa;
        }
        
        .photo-upload input[type="file"] {
            display: none;
        }
        
        .photo-btn {
            width: 100%;
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            min-height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            -webkit-appearance: none;
            background: #3498db;
            color: white;
        }
        
        .photo-btn:active {
            background: #2980b9;
            transform: scale(0.98);
        }
        
        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        /* Photo group label - hidden on screen, visible in print */
        .photo-group-label {
            display: none;
        }
        
        .photo-item {
            position: relative;
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            background: white;
        }
        
        .photo-item img {
            width: 100%;
            height: auto;
            max-height: 350px;
            object-fit: contain;
            border-radius: 4px;
            margin-bottom: 8px;
            background: #f8f9fa;
        }
        
        .photo-item input.caption-input {
            width: 100%;
            padding: 6px;
            font-size: 13px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .photo-item .caption-display {
            display: none;
        }
        
        .photo-item button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            z-index: 10;
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid #ecf0f1;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            -webkit-appearance: none;
            min-height: 44px;
        }
        
        .btn-primary { background: #3498db; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        
        .info-box {
            background: #e8f4f8;
            border-left: 4px solid #3498db;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 4px;
            color: #856404;
            font-size: 13px;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            font-style: italic;
            margin-top: 4px;
        }
        
        /* Print header/footer - hidden on screen */
        .print-header, .print-footer {
            display: none;
        }
        
        /* Section running headers - visible ONLY in print, positioned inline */
        .section-running-header {
            display: none;
        }
        
        /* Print styles */
        @media print {
            body { 
                background: white; 
                padding: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .container { box-shadow: none; padding: 20px; max-width: 100%; }
            .buttons, .photo-upload, .photo-item button, .remove-section-btn, .add-section-btn, .save-indicator { display: none !important; }
            
            /* Hide the auto-save warning box in print */
            .container > .warning-box { display: none !important; }
            
            /* Keep Section D water damage warning visible */
            .section-break .warning-box { display: block !important; }
            
            /* Remove borders from form elements in print */
            textarea, input[type="text"], input[type="date"], select {
                border: none !important;
                background: transparent !important;
                box-shadow: none !important;
                padding-left: 0 !important;
                outline: none !important;
                resize: none !important;
            }
            
            /* Make textareas expand to show all content */
            textarea {
                height: auto !important;
                min-height: 20px !important;
                max-height: none !important;
                overflow: visible !important;
                white-space: pre-wrap !important;
                field-sizing: content !important;
            }
            
            /* Hide placeholder text in print */
            textarea::placeholder, input::placeholder {
                color: transparent !important;
            }
            
            /* For empty textareas, show a minimum height */
            textarea:placeholder-shown {
                min-height: 30px !important;
                border-bottom: 1px solid #ccc !important;
            }
            
            .photo-preview { columns: 2; column-gap: 15px; }
            .photo-item { margin-bottom: 15px; display: inline-block; width: 100%; }
            .photo-item img { max-height: none; }
            
            /* Show full captions in print */
            .photo-item input.caption-input {
                display: none !important;
            }
            
            .photo-item .caption-display {
                display: block !important;
                font-size: 12px;
                color: #333;
                padding: 6px 0;
                word-wrap: break-word;
                white-space: normal;
                line-height: 1.4;
            }
            
            /* Page breaks for main sections */
            .section-break {
                page-break-before: always;
            }
            
            /* Section A should NOT have a page break before it */
            .section-a-container {
                page-break-before: auto;
                page-break-inside: avoid;
            }
            
            /* Compact print styles */
            .container h1 {
                font-size: 16px;
                margin-bottom: 4px;
            }
            
            .container h2 {
                font-size: 14px;
                margin-bottom: 8px;
            }
            
            .container h3 {
                font-size: 12px;
                margin: 8px 0 4px 0;
            }
            
            .form-section {
                margin-bottom: 10px;
            }
            
            .form-group {
                margin-bottom: 6px;
            }
            
            label {
                font-size: 11px;
                margin-bottom: 2px;
            }
            
            input, select, textarea {
                font-size: 11px;
                padding: 4px 0;
                min-height: auto !important;
            }
            
            textarea {
                min-height: 30px !important;
            }
            
            .info-box {
                padding: 6px 10px;
                font-size: 10px;
                margin-bottom: 6px;
            }
            
            .warning-box {
                padding: 6px 10px;
                font-size: 10px;
                margin-bottom: 6px;
            }
            
            .checkbox-group, .radio-group {
                gap: 4px 15px;
            }
            
            .checkbox-item label, .radio-item label {
                font-size: 10px;
            }
            
            .grid-2 {
                gap: 8px 20px;
            }
            
            .section-header h2 {
                font-size: 13px;
            }
            
            .room-section, .facade-section {
                margin-top: 15px;
                padding-top: 10px;
            }
            
            .help-text {
                font-size: 9px;
            }
            
            /* Compact photo display */
            .photo-item {
                padding: 4px;
                border-width: 1px;
            }
            
            .photo-item .caption-display {
                font-size: 10px;
                padding: 4px 0;
            }
            
            /* Only break BEFORE 2nd+ room/facade, not the first one */
            .room-section, .facade-section {
                page-break-before: auto;
            }
            
            .room-section ~ .room-section,
            .facade-section ~ .facade-section {
                page-break-before: always;
            }
            
            /* Section E summary always on new page */
            .summary-section {
                page-break-before: always;
            }
            
            /* Prevent orphaned headers */
            h2, h3 {
                page-break-after: avoid;
            }
            
            /* Keep question and answer together */
            .form-group {
                page-break-inside: avoid;
            }
            
            /* For long textareas, allow breaks but keep label with content start */
            .form-group:has(textarea) {
                page-break-inside: auto;
            }
            
            .form-group label {
                page-break-after: avoid;
            }
            
            textarea {
                page-break-inside: auto;
            }
            
            /* Keep photo sections together */
            .photo-preview {
                page-break-inside: avoid;
            }
            
            /* Photo group labels - visible in print to identify orphaned photos */
            .photo-group-label {
                display: block !important;
                font-size: 11px;
                font-weight: 600;
                color: #1a5276;
                background: #eaf2f8;
                padding: 4px 8px;
                margin-bottom: 8px;
                border-left: 3px solid #3498db;
                page-break-after: avoid;
            }
            
            /* Keep checkbox/radio groups together */
            .checkbox-group, .radio-group {
                page-break-inside: avoid;
            }
            
            /* Hide empty sections in print */
            .room-section.empty-section,
            .facade-section.empty-section {
                display: none !important;
            }
            
            /* Print header on each page */
            .print-header {
                display: block !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 20px;
                padding: 5px 0.5in;
                font-size: 9px;
                color: #666;
                text-align: center;
                border-bottom: 1px solid #ccc;
                background: white;
            }
            
            .print-footer {
                display: block !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 20px;
                padding: 5px 0.5in;
                font-size: 9px;
                color: #666;
                border-top: 1px solid #ccc;
                background: white;
                display: flex !important;
                justify-content: space-between;
            }
            
            .print-footer .left {
                text-align: left;
            }
            
            .print-footer .right {
                text-align: right;
            }
            
            /* Section running headers - INLINE banner at top of each section */
            .section-running-header {
                display: block !important;
                font-size: 10px;
                color: #1a5276;
                background: #eaf2f8;
                padding: 6px 10px;
                margin: -10px -10px 12px -10px;
                border-bottom: 2px solid #3498db;
                font-weight: 600;
            }
            
            /* Add margin to content for fixed header/footer */
            .container {
                margin-top: 30px !important;
                margin-bottom: 30px !important;
            }
            
            @page {
                margin: 0.5in 0.5in 0.6in 0.5in;
                size: letter;
            }
        }
        
        /* Mobile */
        @media screen and (max-width: 768px) {
            body { padding: 8px; }
            .container { padding: 15px 12px; }
            h1 { font-size: 18px; }
            h2 { font-size: 15px; }
            .grid-2 { grid-template-columns: 1fr; }
            .photo-preview { grid-template-columns: 1fr; }
            .buttons { flex-direction: column; }
            .buttons button { width: 100%; }
        }
        
        /* Debug console - DISABLED for production */
        .debug-console {
            display: none !important;
        }
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 5px;
            z-index: 9999;
            display: block; /* ENABLED */
        }
    </style>
</head>
<body>
    <!-- Debug Console -->
    <div class="debug-console" id="debugConsole"></div>
    
    <!-- Print Header -->
    <div class="print-header">
        Heritage Property Conditions Assessment ‚Äî <span id="printPropertyName"></span>
    </div>
    
    <!-- Print Footer -->
    <div class="print-footer">
        <span class="left">Assessment Date: <span id="printDate"></span></span>
        <span class="right">Heritage Property Conditions Assessment</span>
    </div>
    
    <div class="save-indicator saved">
        <div class="icon">‚úì</div>
        <div>
            <div style="font-weight: 600;">Saved</div>
        </div>
    </div>
    
    <div class="container">
        <h1>Checklist 1: Conditions Assessment</h1>
        <p style="text-align: center; color: #7f8c8d; margin-bottom: 8px; font-size: 13px;">Heritage Property Conditions Assessment Form</p>
        
        <div class="warning-box" style="text-align: center;">
            <strong>‚ö° Auto-Save:</strong> Progress saved automatically<br>
            <strong>üì± iPhone Ready:</strong> Download this file and open in Safari for full PDF functionality
        </div>
        
        <!-- SECTION A: Property Information & Initial Steps -->
        <div class="section-a-container" id="sectionA">
            <div class="section-running-header"></div>
            <h2>Section A: Property Information & Initial Steps</h2>
            
            <div class="form-section">
                <div class="grid-2">
                    <div class="form-group">
                        <label for="propertyName">Property Name: *</label>
                        <input type="text" id="propertyName" placeholder="Enter property name" oninput="updateAllRunningHeaders(); triggerAutoSave();">
                    </div>
                    <div class="form-group">
                        <label for="rpaNumber">RPA Number:</label>
                        <input type="text" id="rpaNumber" placeholder="Enter RPA number">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="propertyAddress">Property Address:</label>
                    <textarea id="propertyAddress" placeholder="Full address including postal code" style="min-height: 60px;"></textarea>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="assessmentDate">Assessment Date: *</label>
                        <input type="date" id="assessmentDate">
                    </div>
                    <div class="form-group">
                        <label for="assessor">Assessor Name & Role: *</label>
                        <input type="text" id="assessor" placeholder="Name and role">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label for="weather">Weather Conditions:</label>
                        <select id="weather">
                            <option value="">Select weather</option>
                            <option value="sunny">‚òÄÔ∏è Sunny</option>
                            <option value="cloudy">‚òÅÔ∏è Cloudy</option>
                            <option value="rainy">üåßÔ∏è Rainy</option>
                            <option value="snowy">‚ùÑÔ∏è Snowy</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="temperature">Temperature:</label>
                        <input type="text" id="temperature" placeholder="e.g., 72¬∞F / 22¬∞C">
                    </div>
                </div>
            
                <!-- Heritage Status Questions -->
                <h3>1. Heritage Status</h3>
                <div class="info-box">
                    Check OBO List of Significant Properties at: <br>
                    <a href="https://usdos.sharepoint.com/sites/OBO-CH/SitePages/Historic-Facilities-Maintenance.aspx" target="_blank" style="word-break: break-all;">usdos.sharepoint.com/sites/OBO-CH</a>
                </div>
                
                <div class="form-group">
                    <label>Does the property appear in the OBO List of Significant Properties?</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="oboYes" name="oboList" value="yes">
                            <label for="oboYes">Yes</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="oboNo" name="oboList" value="no">
                            <label for="oboNo">No</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Listing Authority (if applicable):</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="secState" name="authority">
                            <label for="secState">Secretary of State</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="unesco" name="authority">
                            <label for="unesco">UNESCO/World Heritage</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="hostCountry" name="authority">
                            <label for="hostCountry">Host Country</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="local" name="authority">
                            <label for="local">Local Authority</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Available Documentation:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="css" name="docs">
                            <label for="css">Cultural Significance Study (CSS)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="hsr" name="docs">
                            <label for="hsr">Historic Structure Report (HSR)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="clr" name="docs">
                            <label for="clr">Cultural Landscape Report (CLR)</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="sectionANotes">Background Information & Notes:</label>
                    <textarea id="sectionANotes" placeholder="Enter background information, significance, special considerations, references to CSS/HSR, etc."></textarea>
                </div>
            </div>
        </div>
        
        <!-- SECTION B: Interior Assessment -->
        <div class="section-break">
            <h2>Section B: Interior Assessment</h2>
            <div id="roomsContainer"></div>
            <button class="add-section-btn" id="addRoomBtn" onclick="addRoom()">‚ûï Add Room</button>
        </div>
        
        <!-- SECTION C: Fa√ßade Assessment -->
        <div class="section-break">
            <h2>Section C: Fa√ßade Assessment</h2>
            <div id="facadesContainer"></div>
            <button class="add-section-btn" id="addFacadeBtn" onclick="addFacade()">‚ûï Add Fa√ßade</button>
        </div>
        
        <!-- SECTION D: Water Damage Reporting -->
        <div class="section-break" id="siteSection">
            <div class="section-running-header"></div>
            <h2>Section D: Water Damage Reporting</h2>
            <div class="form-section">
                <div class="warning-box">
                    <strong>‚ö†Ô∏è IMPORTANT:</strong> Report any new signs of water damage immediately to prevent further deterioration.
                </div>
                
                <div class="form-group">
                    <label>Signs of Active Water Damage Observed?</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="waterYes" name="waterDamage" value="yes">
                            <label for="waterYes">Yes - Immediate Action Required</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="waterNo" name="waterDamage" value="no">
                            <label for="waterNo">No</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="waterLocation">Location & Description of Water Damage:</label>
                    <textarea id="waterLocation" placeholder="Describe exact location, affected rooms/elements, source if known, extent of damage"></textarea>
                </div>
                
                <div class="form-group">
                    <label>üì∑ Water Damage Photos:</label>
                    <div class="photo-upload">
                        <input type="file" id="waterPhotos" accept="image/*" multiple data-preview="waterPreview">
                        <button type="button" class="photo-btn" data-input="waterPhotos">üì∑ Add Photos</button>
                    </div>
                    <div class="photo-group-label" id="water_photo_label"></div>
                    <div id="waterPreview" class="photo-preview"></div>
                </div>
            </div>
        </div>
        
        <!-- SECTION E: Assessment Summary -->
        <div class="summary-section" id="summarySection">
            <div class="section-running-header"></div>
            <h2>Section E: Assessment Summary</h2>
            <div class="form-section">
                <div class="form-group">
                    <label for="overallFindings">Overall Findings:</label>
                    <textarea id="overallFindings" placeholder="Summarize overall condition, key observations, most significant issues" style="min-height: 100px;"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="recommendations">Recommended Actions & Priorities:</label>
                    <textarea id="recommendations" placeholder="List recommended maintenance, repairs, or treatments in priority order" style="min-height: 100px;"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="urgentItems">Urgent/Critical Items:</label>
                    <textarea id="urgentItems" placeholder="Items requiring immediate attention"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="followUp">Follow-Up Required:</label>
                    <textarea id="followUp" placeholder="Areas requiring further investigation, specialist consultation, or monitoring"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="specialistNeeded">Specialist Assistance Needed:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="heritageArch" name="specialist">
                            <label for="heritageArch">Heritage Architect</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="structEng" name="specialist">
                            <label for="structEng">Structural Engineer</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="conservator" name="specialist">
                            <label for="conservator">Conservator</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="masonrySpec" name="specialist">
                            <label for="masonrySpec">Masonry Specialist</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="roofSpec" name="specialist">
                            <label for="roofSpec">Roofing Specialist</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="buttons">
            <button class="btn-success" onclick="exportData()">üíæ Export Data</button>
            <button class="btn-secondary" onclick="importData()">üì• Import Data</button>
            <button class="btn-warning" onclick="preparePrint()">üìÑ Save as PDF</button>
            <button class="btn-danger" onclick="clearForm()">üóëÔ∏è Clear Form</button>
        </div>
        
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
    </div>

    <script>
        let roomCounter = 0;
        let facadeCounter = 0;
        let autoSaveTimeout;
        let lastSaveTime = new Date();
        let photoDB = null; // IndexedDB database for photos
        
        // ==========================================
        // IndexedDB Setup for Photo Storage
        // ==========================================
        
        function initPhotoDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('HeritageAssessmentPhotos', 1);
                
                request.onerror = function(event) {
                    debugLog('IndexedDB error: ' + event.target.error);
                    reject(event.target.error);
                };
                
                request.onsuccess = function(event) {
                    photoDB = event.target.result;
                    debugLog('IndexedDB opened successfully');
                    resolve(photoDB);
                };
                
                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    // Create object store for photos
                    if (!db.objectStoreNames.contains('photos')) {
                        const store = db.createObjectStore('photos', { keyPath: 'id' });
                        store.createIndex('previewId', 'previewId', { unique: false });
                        debugLog('IndexedDB photo store created');
                    }
                };
            });
        }
        
        // Save a photo to IndexedDB
        function savePhotoToDB(photoId, previewId, imageData, caption) {
            return new Promise((resolve, reject) => {
                if (!photoDB) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = photoDB.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                
                const photoRecord = {
                    id: photoId,
                    previewId: previewId,
                    imageData: imageData,
                    caption: caption,
                    timestamp: new Date().toISOString()
                };
                
                const request = store.put(photoRecord);
                
                request.onsuccess = function() {
                    resolve(photoId);
                };
                
                request.onerror = function(event) {
                    debugLog('Error saving photo: ' + event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        // Get all photos from IndexedDB
        function getAllPhotosFromDB() {
            return new Promise((resolve, reject) => {
                if (!photoDB) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = photoDB.transaction(['photos'], 'readonly');
                const store = transaction.objectStore('photos');
                const request = store.getAll();
                
                request.onsuccess = function() {
                    resolve(request.result);
                };
                
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }
        
        // Get photos for a specific preview container
        function getPhotosForPreview(previewId) {
            return new Promise((resolve, reject) => {
                if (!photoDB) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = photoDB.transaction(['photos'], 'readonly');
                const store = transaction.objectStore('photos');
                const index = store.index('previewId');
                const request = index.getAll(previewId);
                
                request.onsuccess = function() {
                    resolve(request.result);
                };
                
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }
        
        // Delete a photo from IndexedDB
        function deletePhotoFromDB(photoId) {
            return new Promise((resolve, reject) => {
                if (!photoDB) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = photoDB.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                const request = store.delete(photoId);
                
                request.onsuccess = function() {
                    resolve();
                };
                
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }
        
        // Clear all photos from IndexedDB
        function clearAllPhotosFromDB() {
            return new Promise((resolve, reject) => {
                if (!photoDB) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = photoDB.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                const request = store.clear();
                
                request.onsuccess = function() {
                    debugLog('All photos cleared from IndexedDB');
                    resolve();
                };
                
                request.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }
        
        // Update photo caption in IndexedDB
        function updatePhotoCaptionInDB(photoId, newCaption) {
            return new Promise((resolve, reject) => {
                if (!photoDB) {
                    reject(new Error('IndexedDB not initialized'));
                    return;
                }
                
                const transaction = photoDB.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                const getRequest = store.get(photoId);
                
                getRequest.onsuccess = function() {
                    const photo = getRequest.result;
                    if (photo) {
                        photo.caption = newCaption;
                        store.put(photo);
                        resolve();
                    } else {
                        reject(new Error('Photo not found'));
                    }
                };
                
                getRequest.onerror = function(event) {
                    reject(event.target.error);
                };
            });
        }
        
        // Get IndexedDB storage estimate
        async function getStorageEstimate() {
            if (navigator.storage && navigator.storage.estimate) {
                const estimate = await navigator.storage.estimate();
                const usedMB = (estimate.usage / 1024 / 1024).toFixed(2);
                const quotaMB = (estimate.quota / 1024 / 1024).toFixed(0);
                return { usedMB, quotaMB, percentUsed: ((estimate.usage / estimate.quota) * 100).toFixed(1) };
            }
            return null;
        }
        
        // ==========================================
        // End IndexedDB Setup
        // ==========================================
        
        // Debug logging - DISABLED for production
        function debugLog(msg) {
            // Uncomment below lines to enable debugging:
            // console.log('[DEBUG]', msg);
            // const debugEl = document.getElementById('debugConsole');
            // if (debugEl) {
            //     debugEl.innerHTML += msg + '<br>';
            //     debugEl.scrollTop = debugEl.scrollHeight;
            // }
        }
        
        // Prepare print header/footer before printing
        function preparePrint() {
            const propertyName = document.getElementById('propertyName').value || 'Untitled Property';
            const assessmentDate = document.getElementById('assessmentDate').value || new Date().toISOString().split('T')[0];
            
            document.getElementById('printPropertyName').textContent = propertyName;
            document.getElementById('printDate').textContent = assessmentDate;
            
            // Mark empty sections to hide in print
            markEmptySections();
            
            // Update all section running headers
            updateAllRunningHeaders();
            
            window.print();
        }
        
        // Update all running headers for print
        function updateAllRunningHeaders() {
            // Get property name for all headers
            const propertyName = document.getElementById('propertyName')?.value || 'Heritage Property';
            const baseHeader = 'Heritage Property Conditions Assessment ‚Äî ' + propertyName;
            
            // Update Section A header (if exists)
            const sectionAHeader = document.querySelector('#sectionA .section-running-header');
            if (sectionAHeader) {
                sectionAHeader.textContent = baseHeader + ' ‚Äî Property Information';
            }
            
            // Update room running headers and photo labels
            document.querySelectorAll('.room-section').forEach(function(section, index) {
                const nameInput = section.querySelector('input[id$="_name"]');
                const header = section.querySelector('.section-running-header');
                const photoLabel = section.querySelector('.photo-group-label');
                const roomName = nameInput && nameInput.value ? nameInput.value : 'Room ' + (index + 1);
                
                if (header) {
                    header.textContent = baseHeader + ' ‚Äî ' + roomName;
                }
                if (photoLabel) {
                    photoLabel.textContent = 'Photos: ' + propertyName + ' ‚Äî ' + roomName;
                }
            });
            
            // Update facade running headers and photo labels
            document.querySelectorAll('.facade-section').forEach(function(section, index) {
                const facingSelect = section.querySelector('select[id$="_facing"]');
                const header = section.querySelector('.section-running-header');
                const photoLabel = section.querySelector('.photo-group-label');
                
                let facadeName = 'Fa√ßade ' + (index + 1);
                if (facingSelect && facingSelect.value) {
                    facadeName = facingSelect.value + ' Fa√ßade';
                }
                
                if (header) {
                    header.textContent = baseHeader + ' ‚Äî ' + facadeName;
                }
                if (photoLabel) {
                    photoLabel.textContent = 'Photos: ' + propertyName + ' ‚Äî ' + facadeName;
                }
            });
            
            // Update Section D header (Water Damage)
            const sectionDHeader = document.querySelector('#siteSection .section-running-header');
            if (sectionDHeader) {
                sectionDHeader.textContent = baseHeader + ' ‚Äî Water Damage';
            }
            
            // Update water damage photo label
            const waterPhotoLabel = document.getElementById('water_photo_label');
            if (waterPhotoLabel) {
                waterPhotoLabel.textContent = 'Photos: ' + propertyName + ' ‚Äî Water Damage';
            }
            
            // Update Section E header (Summary)
            const sectionEHeader = document.querySelector('#summarySection .section-running-header');
            if (sectionEHeader) {
                sectionEHeader.textContent = baseHeader + ' ‚Äî Assessment Summary';
            }
        }
        
        // Check if a room section is empty
        function isSectionEmpty(section) {
            const nameInput = section.querySelector('input[id$="_name"]');
            const notesTextarea = section.querySelector('textarea');
            const checkedBoxes = section.querySelectorAll('input[type="checkbox"]:checked');
            const selectedRadios = section.querySelectorAll('input[type="radio"]:checked');
            const selectedDropdowns = section.querySelectorAll('select');
            const photos = section.querySelectorAll('.photo-item');
            
            if (!nameInput || !nameInput.value.trim()) {
                if (notesTextarea && notesTextarea.value.trim()) return false;
                if (checkedBoxes.length > 0) return false;
                if (photos.length > 0) return false;
                
                for (let dropdown of selectedDropdowns) {
                    if (dropdown.value && dropdown.selectedIndex > 0) return false;
                }
                
                return true;
            }
            return false;
        }
        
        // Mark empty sections before printing
        function markEmptySections() {
            document.querySelectorAll('.room-section').forEach(section => {
                if (isSectionEmpty(section)) {
                    section.classList.add('empty-section');
                } else {
                    section.classList.remove('empty-section');
                }
            });
            
            document.querySelectorAll('.facade-section').forEach(section => {
                if (isSectionEmpty(section)) {
                    section.classList.add('empty-section');
                } else {
                    section.classList.remove('empty-section');
                }
            });
        }
        
        // Before print event handler
        window.addEventListener('beforeprint', function() {
            const propertyName = document.getElementById('propertyName').value || 'Untitled Property';
            const assessmentDate = document.getElementById('assessmentDate').value || new Date().toISOString().split('T')[0];
            
            document.getElementById('printPropertyName').textContent = propertyName;
            document.getElementById('printDate').textContent = assessmentDate;
            
            markEmptySections();
            updateAllRunningHeaders();
            
            // Auto-expand all textareas
            document.querySelectorAll('textarea').forEach(function(textarea) {
                textarea.dataset.originalStyle = textarea.getAttribute('style') || '';
                textarea.style.height = 'auto';
                textarea.style.minHeight = '0';
                textarea.style.maxHeight = 'none';
                textarea.style.overflow = 'visible';
                textarea.style.height = (textarea.scrollHeight + 5) + 'px';
            });
        });
        
        // After print event handler
        window.addEventListener('afterprint', function() {
            document.querySelectorAll('.empty-section').forEach(section => {
                section.classList.remove('empty-section');
            });
            
            document.querySelectorAll('textarea').forEach(function(textarea) {
                if (textarea.dataset.originalStyle) {
                    textarea.setAttribute('style', textarea.dataset.originalStyle);
                } else {
                    textarea.removeAttribute('style');
                }
            });
        });
        
        // Page load handler
        window.addEventListener('load', async function() {
            debugLog('Page loaded');
            
            // Initialize IndexedDB for photos
            try {
                await initPhotoDB();
                debugLog('Photo database ready');
                
                // Show storage estimate
                const storage = await getStorageEstimate();
                if (storage) {
                    debugLog('Storage: ' + storage.usedMB + ' MB used of ' + storage.quotaMB + ' MB (' + storage.percentUsed + '%)');
                }
            } catch (e) {
                debugLog('IndexedDB init failed: ' + e.message);
                // Continue anyway - will fall back to localStorage
            }
            
            const saved = localStorage.getItem('assessmentForm');
            let roomsToCreate = 1;
            let facadesToCreate = 1;
            
            if (saved) {
                try {
                    const formData = JSON.parse(saved);
                    debugLog('Found saved data: ' + formData.roomCount + ' rooms, ' + formData.facadeCount + ' facades');
                    roomsToCreate = formData.roomCount || 1;
                    facadesToCreate = formData.facadeCount || 1;
                } catch (e) {
                    debugLog('Error parsing saved data: ' + e.message);
                }
            } else {
                debugLog('No saved data found');
            }
            
            // Create rooms and facades
            for (let i = 0; i < roomsToCreate; i++) {
                addRoom();
            }
            for (let i = 0; i < facadesToCreate; i++) {
                addFacade();
            }
            
            // Load the form data (non-photo fields)
            loadFormData();
            
            // Load photos from IndexedDB
            await loadPhotosFromDB();
            
            // Set default date
            if (!document.getElementById('assessmentDate').value) {
                document.getElementById('assessmentDate').value = new Date().toISOString().split('T')[0];
            }
            
            setupPhotoButtons();
        });
        
        // Load photos from IndexedDB into the DOM
        async function loadPhotosFromDB() {
            try {
                const photos = await getAllPhotosFromDB();
                debugLog('Loading ' + photos.length + ' photos from IndexedDB');
                
                photos.forEach(function(photo) {
                    const preview = document.getElementById(photo.previewId);
                    if (preview) {
                        addPhotoToDOM(photo.id, photo.imageData, preview, photo.caption);
                    }
                });
            } catch (e) {
                debugLog('Error loading photos: ' + e.message);
            }
        }
        
        document.addEventListener('input', triggerAutoSave);
        document.addEventListener('change', triggerAutoSave);
        
        function triggerAutoSave() {
            const indicator = document.querySelector('.save-indicator');
            const iconEl = indicator.querySelector('.icon');
            const textEl = indicator.querySelector('div div');
            
            indicator.className = 'save-indicator saving';
            if (iconEl) iconEl.textContent = '‚Üª';
            if (textEl) textEl.textContent = 'Saving...';
            
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(function() {
                try {
                    saveFormData();
                    indicator.className = 'save-indicator saved';
                    if (iconEl) iconEl.textContent = '‚úì';
                    if (textEl) textEl.textContent = 'Saved';
                    lastSaveTime = new Date();
                } catch (e) {
                    console.error('Save error:', e);
                    indicator.className = 'save-indicator saved';
                    if (iconEl) iconEl.textContent = '‚úì';
                    if (textEl) textEl.textContent = 'Saved';
                }
            }, 1000);
        }
        
        function saveFormData() {
            const formData = {
                roomCount: roomCounter,
                facadeCount: facadeCounter,
                timestamp: new Date().toISOString(),
                data: {}
            };
            
            // Track Section E specifically
            const sectionEFields = ['overallFindings', 'recommendations', 'urgentItems', 'followUp'];
            let sectionEStatus = [];
            
            document.querySelectorAll('input, textarea, select').forEach(function(el) {
                if (el.id && el.type !== 'file') {
                    if (el.type === 'checkbox' || el.type === 'radio') {
                        formData.data[el.id] = el.checked;
                    } else {
                        formData.data[el.id] = el.value;
                    }
                    
                    // Track Section E fields
                    if (sectionEFields.includes(el.id)) {
                        sectionEStatus.push(el.id + '=' + (el.value ? '"' + el.value.substring(0,30) + '..."' : '(empty)'));
                    }
                }
            });
            
            // NOTE: Photos are now stored in IndexedDB, not localStorage
            // This keeps localStorage small and prevents quota errors
            
            const jsonData = JSON.stringify(formData);
            const dataSizeMB = (jsonData.length / 1024 / 1024).toFixed(3);
            
            try {
                localStorage.setItem('assessmentForm', jsonData);
                debugLog('Saved: ' + Object.keys(formData.data).length + ' fields (' + dataSizeMB + ' MB)');
                debugLog('Section E: ' + sectionEStatus.join(', '));
                console.log('[SAVE] Section E status:', sectionEStatus);
                
                return { success: true, data: formData };
            } catch (e) {
                debugLog('SAVE ERROR: ' + e.message);
                console.error('Save error:', e);
                
                // Show prominent warning
                showStorageError(dataSizeMB);
                
                // Return the data anyway so export can use it directly
                return { success: false, data: formData, error: e.message };
            }
        }
        
        // Save a single photo to IndexedDB (called when photo is added)
        async function savePhotoToStorage(photoId, previewId, imageData, caption) {
            try {
                await savePhotoToDB(photoId, previewId, imageData, caption);
                debugLog('Photo saved to IndexedDB: ' + photoId);
                
                // Show updated storage estimate
                const storage = await getStorageEstimate();
                if (storage) {
                    debugLog('Storage now: ' + storage.usedMB + ' MB (' + storage.percentUsed + '%)');
                }
            } catch (e) {
                debugLog('Error saving photo to IndexedDB: ' + e.message);
            }
        }
        
        function showStorageWarning(sizeMB) {
            const existing = document.getElementById('storageWarning');
            if (existing) existing.remove();
            
            const warning = document.createElement('div');
            warning.id = 'storageWarning';
            warning.style.cssText = 'position:fixed;top:50px;right:10px;background:#fff3cd;border:2px solid #ffc107;padding:10px 15px;border-radius:8px;z-index:1001;max-width:300px;font-size:13px;box-shadow:0 2px 10px rgba(0,0,0,0.2);';
            warning.innerHTML = '<strong>‚ö†Ô∏è Storage Warning</strong><br>Data size: ' + sizeMB + ' MB<br>Consider exporting soon.<br><button onclick="this.parentElement.remove()" style="margin-top:8px;padding:4px 12px;cursor:pointer;">Dismiss</button>';
            document.body.appendChild(warning);
        }
        
        function showStorageError(sizeMB) {
            const existing = document.getElementById('storageError');
            if (existing) existing.remove();
            
            const error = document.createElement('div');
            error.id = 'storageError';
            error.style.cssText = 'position:fixed;top:50px;left:50%;transform:translateX(-50%);background:#f8d7da;border:2px solid #dc3545;padding:15px 20px;border-radius:8px;z-index:1002;max-width:400px;font-size:14px;box-shadow:0 4px 20px rgba(0,0,0,0.3);text-align:center;';
            error.innerHTML = '<strong>‚ùå Storage Error</strong><br><br>Click "Export Data" now to save your work.<br><br><button onclick="this.parentElement.remove()" style="padding:8px 20px;cursor:pointer;font-size:14px;">I Understand</button>';
            document.body.appendChild(error);
        }
        
        function loadFormData() {
            const saved = localStorage.getItem('assessmentForm');
            if (!saved) return;
            
            try {
                const formData = JSON.parse(saved);
                debugLog('Loading ' + Object.keys(formData.data).length + ' fields from localStorage');
                
                // Populate form fields (photos are loaded separately from IndexedDB)
                let loadedCount = 0;
                
                Object.keys(formData.data).forEach(function(key) {
                    // Skip photo data - photos are now in IndexedDB
                    if (key.includes('_photo_')) return;
                    
                    const el = document.getElementById(key);
                    if (el) {
                        if (el.type === 'checkbox' || el.type === 'radio') {
                            el.checked = formData.data[key];
                        } else {
                            el.value = formData.data[key];
                        }
                        loadedCount++;
                    }
                });
                
                debugLog('Loaded ' + loadedCount + ' form fields');
                
            } catch (e) {
                debugLog('Error loading form data: ' + e.message);
            }
        }
        
        async function exportData() {
            // Force a save before export
            debugLog('=== EXPORT STARTING ===');
            
            let formData;
            
            try {
                const saveResult = saveFormData();
                debugLog('Form data save completed, success: ' + saveResult.success);
                formData = saveResult.data;
            } catch(e) {
                debugLog('SAVE ERROR: ' + e.message);
                console.error('Save error:', e);
                return;
            }
            
            // Now collect photos from IndexedDB
            try {
                debugLog('Collecting photos from IndexedDB...');
                const photos = await getAllPhotosFromDB();
                debugLog('Found ' + photos.length + ' photos in IndexedDB');
                
                // Add photos to the form data
                photos.forEach(function(photo, index) {
                    formData.data[photo.previewId + '_photo_' + index + '_src'] = photo.imageData;
                    formData.data[photo.previewId + '_photo_' + index + '_caption'] = photo.caption || '';
                    formData.data[photo.previewId + '_photo_' + index + '_id'] = photo.id;
                });
                
            } catch(e) {
                debugLog('Error collecting photos: ' + e.message);
            }
            
            // Convert to JSON
            const data = JSON.stringify(formData);
            const dataSizeMB = (data.length / 1024 / 1024).toFixed(2);
            
            debugLog('Total export size: ' + dataSizeMB + ' MB');
            debugLog('Total keys: ' + Object.keys(formData.data).length);
            
            // Check Section E
            const sectionE = ['overallFindings', 'recommendations', 'urgentItems', 'followUp'];
            sectionE.forEach(function(field) {
                const val = formData.data[field];
                debugLog(field + ': ' + (val ? val.substring(0,20) + '...' : '(EMPTY!)'));
            });
            
            const propertyName = document.getElementById('propertyName')?.value || 'Assessment';
            const date = new Date().toISOString().split('T')[0];
            const filename = propertyName.replace(/[^a-z0-9]/gi, '_') + '_' + date + '.json';
            
            debugLog('Filename: ' + filename);
            
            // Try modern share API first (iOS)
            if (navigator.share && navigator.canShare) {
                debugLog('Trying Share API...');
                try {
                    const file = new File([data], filename, { type: 'application/json' });
                    if (navigator.canShare({ files: [file] })) {
                        navigator.share({
                            files: [file],
                            title: 'Assessment Data Export'
                        }).then(function() {
                            debugLog('Shared successfully');
                        }).catch(function(err) {
                            debugLog('Share failed: ' + err);
                            fallbackExport(data, filename);
                        });
                        return;
                    }
                } catch (e) {
                    debugLog('Share API error: ' + e);
                }
            }
            
            debugLog('Using fallback export...');
            fallbackExport(data, filename);
        }
        
        function fallbackExport(data, filename) {
            debugLog('fallbackExport called');
            try {
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                debugLog('Blob URL created');
                
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                debugLog('Is iOS: ' + isIOS);
                
                if (isIOS) {
                    const newWindow = window.open(url, '_blank');
                    if (newWindow) {
                        debugLog('Opened in new window');
                        alert('‚úÖ Data opened in new tab.\n\nTo save: Long-press and select "Download Linked File"');
                    } else {
                        debugLog('Popup blocked');
                        alert('Popup blocked. Please allow popups for this site.');
                    }
                } else {
                    debugLog('Creating download link...');
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    setTimeout(function() { URL.revokeObjectURL(url); }, 100);
                    debugLog('Download triggered');
                    alert('‚úÖ Data exported successfully!');
                }
            } catch (e) {
                debugLog('FALLBACK ERROR: ' + e.message);
                console.error('Export error:', e);
                alert('Export failed: ' + e.message);
            }
        }
        
        function importData() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            
            if (isIOS) {
                const modal = document.createElement('div');
                modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;';
                modal.innerHTML = '<div style="background:white;padding:30px;border-radius:12px;text-align:center;max-width:90%;margin:20px;">' +
                    '<h3 style="margin-top:0;">Import Assessment Data</h3>' +
                    '<p>Select your saved .json file:</p>' +
                    '<input type="file" id="iosImportFile" accept=".json,application/json" style="margin:15px 0;font-size:16px;">' +
                    '<br>' +
                    '<button onclick="this.closest(\'div\').parentElement.remove();" style="padding:12px 24px;font-size:16px;margin-top:10px;">Cancel</button>' +
                    '</div>';
                document.body.appendChild(modal);
                
                document.getElementById('iosImportFile').addEventListener('change', function(e) {
                    handleImport(e);
                    modal.remove();
                });
            } else {
                if (!confirm('Import data? This will replace current form data.')) return;
                document.getElementById('importFile').click();
            }
        }

        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            debugLog('Importing file: ' + file.name);
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const rawData = e.target.result;
                    const formData = JSON.parse(rawData);
                    
                    debugLog('Parsed data: ' + formData.roomCount + ' rooms, ' + formData.facadeCount + ' facades');
                    
                    // Validate the data structure
                    if (!formData.data) {
                        throw new Error('Invalid file format - missing data property');
                    }
                    
                    // Clear existing photos from IndexedDB
                    try {
                        await clearAllPhotosFromDB();
                        debugLog('Cleared existing photos from IndexedDB');
                    } catch(e) {
                        debugLog('Error clearing photos: ' + e.message);
                    }
                    
                    // Extract photos from the imported data and save to IndexedDB
                    const photoKeys = Object.keys(formData.data).filter(k => k.includes('_photo_') && k.endsWith('_src'));
                    debugLog('Found ' + photoKeys.length + ' photos in import file');
                    
                    for (const key of photoKeys) {
                        const previewId = key.substring(0, key.indexOf('_photo_'));
                        const photoId = key.replace('_src', '').replace(previewId + '_photo_', previewId + '_photo_import_');
                        const captionKey = key.replace('_src', '_caption');
                        const caption = formData.data[captionKey] || '';
                        const imageData = formData.data[key];
                        
                        try {
                            await savePhotoToDB(photoId, previewId, imageData, caption);
                        } catch(e) {
                            debugLog('Error saving imported photo: ' + e.message);
                        }
                        
                        // Remove photo from formData so it doesn't go into localStorage
                        delete formData.data[key];
                        delete formData.data[captionKey];
                        if (formData.data[key.replace('_src', '_id')]) {
                            delete formData.data[key.replace('_src', '_id')];
                        }
                    }
                    
                    // Save non-photo data to localStorage
                    localStorage.setItem('assessmentForm', JSON.stringify(formData));
                    
                    // Clear existing rooms and facades
                    const roomsContainer = document.getElementById('roomsContainer');
                    const facadesContainer = document.getElementById('facadesContainer');
                    
                    roomsContainer.innerHTML = '';
                    facadesContainer.innerHTML = '';
                    roomCounter = 0;
                    facadeCounter = 0;
                    
                    // Create the correct number of rooms
                    const roomsToCreate = formData.roomCount || 1;
                    debugLog('Creating ' + roomsToCreate + ' rooms');
                    for (let i = 0; i < roomsToCreate; i++) {
                        addRoom();
                    }
                    
                    // Create the correct number of facades
                    const facadesToCreate = formData.facadeCount || 1;
                    debugLog('Creating ' + facadesToCreate + ' facades');
                    for (let i = 0; i < facadesToCreate; i++) {
                        addFacade();
                    }
                    
                    // Small delay to ensure DOM is ready
                    setTimeout(async function() {
                        // Populate all form fields
                        let loadedCount = 0;
                        
                        Object.keys(formData.data).forEach(function(key) {
                            const el = document.getElementById(key);
                            if (el) {
                                if (el.type === 'checkbox' || el.type === 'radio') {
                                    el.checked = formData.data[key];
                                } else {
                                    el.value = formData.data[key];
                                }
                                loadedCount++;
                            }
                        });
                        
                        debugLog('Loaded ' + loadedCount + ' form fields');
                        
                        // Load photos from IndexedDB into the DOM
                        await loadPhotosFromDB();
                        
                        setupPhotoButtons();
                        
                        // Show storage estimate
                        const storage = await getStorageEstimate();
                        if (storage) {
                            debugLog('Storage: ' + storage.usedMB + ' MB used');
                        }
                        
                        alert('‚úÖ Data imported successfully!\n\n' + loadedCount + ' fields + ' + photoKeys.length + ' photos loaded.');
                        
                    }, 100);
                    
                } catch (error) {
                    console.error('Import error:', error);
                    debugLog('Import error: ' + error.message);
                    alert('‚ùå Error importing: ' + error.message);
                }
            };
            reader.onerror = function(e) {
                console.error('FileReader error:', e);
                alert('‚ùå Error reading file');
            };
            reader.readAsText(file);
        }
        
        async function clearForm() {
            if (confirm('Clear all data? This cannot be undone.')) {
                localStorage.removeItem('assessmentForm');
                try {
                    await clearAllPhotosFromDB();
                    debugLog('Photos cleared from IndexedDB');
                } catch(e) {
                    debugLog('Error clearing photos: ' + e.message);
                }
                location.reload();
            }
        }
        
        function setupPhotoButtons() {
            document.querySelectorAll('.photo-btn').forEach(function(btn) {
                if (btn.hasAttribute('data-initialized')) return;
                btn.setAttribute('data-initialized', 'true');
                
                const inputId = btn.getAttribute('data-input');
                const input = document.getElementById(inputId);
                if (input && !input.hasAttribute('data-initialized')) {
                    input.setAttribute('data-initialized', 'true');
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        input.click();
                    });
                    input.addEventListener('change', function(e) {
                        const previewId = this.getAttribute('data-preview');
                        handlePhotoUpload(e, previewId);
                    });
                }
            });
        }
        
        function handlePhotoUpload(event, previewId) {
            const files = event.target.files;
            const preview = document.getElementById(previewId);
            if (!files || !preview) return;
            
            Array.from(files).forEach(function(file) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = async function() {
                            try {
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                let width = img.width;
                                let height = img.height;
                                // Reduced to 800px max for smaller file sizes
                                const maxSize = 800;
                                
                                if (width > maxSize || height > maxSize) {
                                    if (width > height) {
                                        height = (height / width) * maxSize;
                                        width = maxSize;
                                    } else {
                                        width = (width / height) * maxSize;
                                        height = maxSize;
                                    }
                                }
                                
                                canvas.width = width;
                                canvas.height = height;
                                ctx.drawImage(img, 0, 0, width, height);
                                // Reduced quality to 50% for smaller file sizes
                                const dataUrl = canvas.toDataURL('image/jpeg', 0.50);
                                
                                // Generate unique photo ID
                                const photoId = previewId + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                                
                                // Show size in debug
                                const photoSizeKB = Math.round(dataUrl.length / 1024);
                                debugLog('Photo added: ' + photoSizeKB + ' KB');
                                
                                // Save to IndexedDB
                                await savePhotoToStorage(photoId, previewId, dataUrl, '');
                                
                                // Add to DOM
                                addPhotoToDOM(photoId, dataUrl, preview, '');
                                
                            } catch (err) {
                                debugLog('Photo processing error: ' + err.message);
                                // Fallback - still try to add the photo
                                const photoId = previewId + '_' + Date.now();
                                addPhotoToDOM(photoId, e.target.result, preview, '');
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            setTimeout(function() { event.target.value = ''; }, 100);
        }
        
        function updateRunningHeader(input, roomId) {
            const section = document.getElementById(roomId);
            if (section) {
                const header = section.querySelector('.section-running-header');
                if (header) {
                    const roomName = input.value || 'Room ' + roomId.replace('room', '');
                    header.textContent = 'Section B: Interior Assessment ‚Äî ' + roomName;
                }
            }
        }
        
        function updateFacadeRunningHeader(select, facadeId) {
            const section = document.getElementById(facadeId);
            if (section) {
                const header = section.querySelector('.section-running-header');
                if (header) {
                    const direction = select.value || '';
                    const num = facadeId.replace('facade', '');
                    const facadeName = direction ? direction + ' Fa√ßade' : 'Fa√ßade ' + num;
                    header.textContent = 'Section C: Fa√ßade Assessment ‚Äî ' + facadeName;
                }
            }
        }
        
        // Add photo to DOM (display only - doesn't save to IndexedDB)
        function addPhotoToDOM(photoId, imageSrc, preview, caption) {
            const photoItem = document.createElement('div');
            photoItem.className = 'photo-item';
            photoItem.setAttribute('data-photo-id', photoId);
            photoItem.innerHTML = '<button onclick="removePhoto(this)">√ó</button>' +
                '<img src="' + imageSrc + '" alt="Photo">' +
                '<input type="text" class="caption-input" placeholder="Add caption..." value="' + (caption || '') + '" onchange="updatePhotoCaption(this)">' +
                '<div class="caption-display">' + (caption || '') + '</div>';
            preview.appendChild(photoItem);
        }
        
        // Legacy function - redirects to addPhotoToDOM
        function addPhotoDirectly(imageSrc, preview, caption) {
            const photoId = preview.id + '_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            addPhotoToDOM(photoId, imageSrc, preview, caption);
            // Also save to IndexedDB
            savePhotoToStorage(photoId, preview.id, imageSrc, caption);
        }
        
        // Update photo caption in IndexedDB when changed
        async function updatePhotoCaption(input) {
            const display = input.parentElement.querySelector('.caption-display');
            if (display) {
                display.textContent = input.value;
            }
            
            // Update in IndexedDB
            const photoItem = input.closest('.photo-item');
            const photoId = photoItem?.getAttribute('data-photo-id');
            if (photoId) {
                try {
                    await updatePhotoCaptionInDB(photoId, input.value);
                    debugLog('Caption updated for ' + photoId);
                } catch(e) {
                    debugLog('Error updating caption: ' + e.message);
                }
            }
        }
        
        function updateCaption(input) {
            updatePhotoCaption(input);
        }
        
        async function removePhoto(button) {
            if (button && button.parentElement) {
                const photoItem = button.parentElement;
                const photoId = photoItem.getAttribute('data-photo-id');
                
                // Remove from IndexedDB
                if (photoId) {
                    try {
                        await deletePhotoFromDB(photoId);
                        debugLog('Photo deleted from IndexedDB: ' + photoId);
                    } catch(e) {
                        debugLog('Error deleting photo: ' + e.message);
                    }
                }
                
                // Remove from DOM
                photoItem.remove();
                triggerAutoSave();
            }
        }
        
        function addRoom() {
            roomCounter++;
            const roomId = 'room' + roomCounter;
            const container = document.getElementById('roomsContainer');
            const removeBtn = roomCounter > 1 ? '<button class="remove-section-btn" data-section="' + roomId + '">Remove</button>' : '';
            
            debugLog('Adding room: ' + roomId);
            
            const roomSection = document.createElement('div');
            roomSection.className = 'room-section';
            roomSection.id = roomId;
            roomSection.innerHTML = '<div class="section-running-header"></div>' +
                '<div class="section-header">' +
                    '<h2>B.' + roomCounter + ': Room ' + roomCounter + '</h2>' +
                    removeBtn +
                '</div>' +
                '<div class="form-group">' +
                    '<label for="' + roomId + '_name">Room Name/Number: *</label>' +
                    '<input type="text" id="' + roomId + '_name" placeholder="e.g., Main Hall, Kitchen, Room 201" onchange="updateRunningHeader(this, \'' + roomId + '\')">' +
                '</div>' +
                '<div class="form-group">' +
                    '<label>Preservation Zone:</label>' +
                    '<div class="radio-group">' +
                        '<div class="radio-item">' +
                            '<input type="radio" id="' + roomId + '_pres" name="' + roomId + '_zone" value="preservation">' +
                            '<label for="' + roomId + '_pres">Preservation</label>' +
                        '</div>' +
                        '<div class="radio-item">' +
                            '<input type="radio" id="' + roomId + '_rest" name="' + roomId + '_zone" value="restoration">' +
                            '<label for="' + roomId + '_rest">Restoration</label>' +
                        '</div>' +
                        '<div class="radio-item">' +
                            '<input type="radio" id="' + roomId + '_adapt" name="' + roomId + '_zone" value="adaptive">' +
                            '<label for="' + roomId + '_adapt">Adaptive Reuse</label>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label for="' + roomId + '_condition">Overall Condition:</label>' +
                    '<select id="' + roomId + '_condition">' +
                        '<option value="">Select condition</option>' +
                        '<option value="good">Good</option>' +
                        '<option value="fair">Fair</option>' +
                        '<option value="poor">Poor</option>' +
                    '</select>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label>Deficiencies Observed:</label>' +
                    '<div class="checkbox-group">' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + roomId + '_crack" name="' + roomId + '_deficiency"><label for="' + roomId + '_crack">Cracking</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + roomId + '_stain" name="' + roomId + '_deficiency"><label for="' + roomId + '_stain">Staining</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + roomId + '_water" name="' + roomId + '_deficiency"><label for="' + roomId + '_water">Water Damage</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + roomId + '_peel" name="' + roomId + '_deficiency"><label for="' + roomId + '_peel">Peeling/Flaking</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + roomId + '_loose" name="' + roomId + '_deficiency"><label for="' + roomId + '_loose">Loose/Detached</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + roomId + '_decay" name="' + roomId + '_deficiency"><label for="' + roomId + '_decay">Decay/Rot</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + roomId + '_corrosion" name="' + roomId + '_deficiency"><label for="' + roomId + '_corrosion">Corrosion</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + roomId + '_missing" name="' + roomId + '_deficiency"><label for="' + roomId + '_missing">Missing Elements</label></div>' +
                    '</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label for="' + roomId + '_urgency">Urgency Rating:</label>' +
                    '<select id="' + roomId + '_urgency">' +
                        '<option value="">Select urgency</option>' +
                        '<option value="minor">Minor (5-10 years)</option>' +
                        '<option value="urgent">Urgent (1-5 years)</option>' +
                        '<option value="critical">Critical (within 1 year)</option>' +
                    '</select>' +
                    '<div class="help-text">Based on 10-year look-ahead</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label>Required Treatment:</label>' +
                    '<div class="checkbox-group">' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + roomId + '_monitor" name="' + roomId + '_treatment"><label for="' + roomId + '_monitor">Continue Monitoring</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + roomId + '_treat" name="' + roomId + '_treatment"><label for="' + roomId + '_treat">Treatment Required</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + roomId + '_maintain" name="' + roomId + '_treatment"><label for="' + roomId + '_maintain">Recurring Maintenance</label></div>' +
                    '</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label for="' + roomId + '_change">Change Since Last Assessment:</label>' +
                    '<select id="' + roomId + '_change">' +
                        '<option value="">Select change status</option>' +
                        '<option value="no_change">No Change</option>' +
                        '<option value="improved">Improved</option>' +
                        '<option value="deteriorated">Deteriorated</option>' +
                        '<option value="new_damage">New Damage</option>' +
                    '</select>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label for="' + roomId + '_notes">Condition Notes & Deficiencies:</label>' +
                    '<textarea id="' + roomId + '_notes" placeholder="Describe condition of: walls, floors, ceiling, windows, doors, fixtures, finishes, decorative elements. Note any deficiencies, causes if known, and recommended treatments."></textarea>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label>üì∑ Room Photos:</label>' +
                    '<div class="photo-upload">' +
                        '<input type="file" id="' + roomId + '_photos" accept="image/*" multiple data-preview="' + roomId + '_preview">' +
                        '<button type="button" class="photo-btn" data-input="' + roomId + '_photos">üì∑ Add Photos</button>' +
                    '</div>' +
                    '<div class="photo-group-label" id="' + roomId + '_photo_label"></div>' +
                    '<div id="' + roomId + '_preview" class="photo-preview"></div>' +
                '</div>';
            container.appendChild(roomSection);
            
            if (roomCounter > 1) {
                roomSection.querySelector('.remove-section-btn').addEventListener('click', function() {
                    if (confirm('Remove this room?')) {
                        document.getElementById(roomId).remove();
                        renumberRooms();
                        triggerAutoSave();
                    }
                });
                
                document.getElementById('addRoomBtn').textContent = '‚ûï Add Another Room';
            }
            
            setupPhotoButtons();
            updateAllRunningHeaders();
        }
        
        function renumberRooms() {
            const rooms = document.querySelectorAll('.room-section');
            roomCounter = rooms.length;
            
            const addBtn = document.getElementById('addRoomBtn');
            if (addBtn) {
                addBtn.textContent = roomCounter > 1 ? '‚ûï Add Another Room' : '‚ûï Add Room';
            }
            
            rooms.forEach(function(room, index) {
                const num = index + 1;
                const header = room.querySelector('.section-header h2');
                if (header) {
                    header.textContent = 'B.' + num + ': Room ' + num;
                }
                
                const removeBtn = room.querySelector('.remove-section-btn');
                if (num === 1 && removeBtn) {
                    removeBtn.style.display = 'none';
                } else if (num > 1 && removeBtn) {
                    removeBtn.style.display = '';
                }
            });
        }
        
        function addFacade() {
            facadeCounter++;
            const facadeId = 'facade' + facadeCounter;
            const container = document.getElementById('facadesContainer');
            const removeBtn = facadeCounter > 1 ? '<button class="remove-section-btn" data-section="' + facadeId + '">Remove</button>' : '';
            
            debugLog('Adding facade: ' + facadeId);
            
            const facadeSection = document.createElement('div');
            facadeSection.className = 'facade-section';
            facadeSection.id = facadeId;
            facadeSection.innerHTML = '<div class="section-running-header"></div>' +
                '<div class="section-header">' +
                    '<h2>C.' + facadeCounter + ': Fa√ßade ' + facadeCounter + '</h2>' +
                    removeBtn +
                '</div>' +
                '<div class="form-group">' +
                    '<label for="' + facadeId + '_facing">Facing Direction:</label>' +
                    '<select id="' + facadeId + '_facing" onchange="updateFacadeRunningHeader(this, \'' + facadeId + '\')">' +
                        '<option value="">Select direction</option>' +
                        '<option value="North">North</option>' +
                        '<option value="South">South</option>' +
                        '<option value="East">East</option>' +
                        '<option value="West">West</option>' +
                        '<option value="Northeast">Northeast</option>' +
                        '<option value="Northwest">Northwest</option>' +
                        '<option value="Southeast">Southeast</option>' +
                        '<option value="Southwest">Southwest</option>' +
                    '</select>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label>Preservation Zone:</label>' +
                    '<div class="radio-group">' +
                        '<div class="radio-item">' +
                            '<input type="radio" id="' + facadeId + '_pres" name="' + facadeId + '_zone" value="preservation">' +
                            '<label for="' + facadeId + '_pres">Preservation</label>' +
                        '</div>' +
                        '<div class="radio-item">' +
                            '<input type="radio" id="' + facadeId + '_rest" name="' + facadeId + '_zone" value="restoration">' +
                            '<label for="' + facadeId + '_rest">Restoration</label>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label for="' + facadeId + '_condition">Overall Condition:</label>' +
                    '<select id="' + facadeId + '_condition">' +
                        '<option value="">Select condition</option>' +
                        '<option value="good">Good</option>' +
                        '<option value="fair">Fair</option>' +
                        '<option value="poor">Poor</option>' +
                    '</select>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label>Deficiencies Observed:</label>' +
                    '<div class="checkbox-group">' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + facadeId + '_crack" name="' + facadeId + '_deficiency"><label for="' + facadeId + '_crack">Cracking</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + facadeId + '_stain" name="' + facadeId + '_deficiency"><label for="' + facadeId + '_stain">Staining</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + facadeId + '_water" name="' + facadeId + '_deficiency"><label for="' + facadeId + '_water">Water Damage</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + facadeId + '_spall" name="' + facadeId + '_deficiency"><label for="' + facadeId + '_spall">Spalling</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + facadeId + '_efflor" name="' + facadeId + '_deficiency"><label for="' + facadeId + '_efflor">Efflorescence</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + facadeId + '_point" name="' + facadeId + '_deficiency"><label for="' + facadeId + '_point">Failed Pointing</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + facadeId + '_corrosion" name="' + facadeId + '_deficiency"><label for="' + facadeId + '_corrosion">Corrosion</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + facadeId + '_missing" name="' + facadeId + '_deficiency"><label for="' + facadeId + '_missing">Missing Elements</label></div>' +
                    '</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label for="' + facadeId + '_urgency">Urgency Rating:</label>' +
                    '<select id="' + facadeId + '_urgency">' +
                        '<option value="">Select urgency</option>' +
                        '<option value="minor">Minor (5-10 years)</option>' +
                        '<option value="urgent">Urgent (1-5 years)</option>' +
                        '<option value="critical">Critical (within 1 year)</option>' +
                    '</select>' +
                    '<div class="help-text">Based on 10-year look-ahead</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label>Required Treatment:</label>' +
                    '<div class="checkbox-group">' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + facadeId + '_monitor" name="' + facadeId + '_treatment"><label for="' + facadeId + '_monitor">Continue Monitoring</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + facadeId + '_treat" name="' + facadeId + '_treatment"><label for="' + facadeId + '_treat">Treatment Required</label></div>' +
                        '<div class="checkbox-item"><input type="checkbox" id="' + facadeId + '_maintain" name="' + facadeId + '_treatment"><label for="' + facadeId + '_maintain">Recurring Maintenance</label></div>' +
                    '</div>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label for="' + facadeId + '_change">Change Since Last Assessment:</label>' +
                    '<select id="' + facadeId + '_change">' +
                        '<option value="">Select change status</option>' +
                        '<option value="no_change">No Change</option>' +
                        '<option value="improved">Improved</option>' +
                        '<option value="deteriorated">Deteriorated</option>' +
                        '<option value="new_damage">New Damage</option>' +
                    '</select>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label for="' + facadeId + '_notes">Condition Notes & Deficiencies:</label>' +
                    '<textarea id="' + facadeId + '_notes" placeholder="Describe condition of: exterior walls, masonry, stucco, paint, windows, doors, roofing, rainwater goods, decorative elements. Note any deficiencies, causes if known, and recommended treatments."></textarea>' +
                '</div>' +
                '<div class="form-group">' +
                    '<label>üì∑ Fa√ßade Photos:</label>' +
                    '<div class="photo-upload">' +
                        '<input type="file" id="' + facadeId + '_photos" accept="image/*" multiple data-preview="' + facadeId + '_preview">' +
                        '<button type="button" class="photo-btn" data-input="' + facadeId + '_photos">üì∑ Add Photos</button>' +
                    '</div>' +
                    '<div class="photo-group-label" id="' + facadeId + '_photo_label"></div>' +
                    '<div id="' + facadeId + '_preview" class="photo-preview"></div>' +
                '</div>';
            container.appendChild(facadeSection);
            
            if (facadeCounter > 1) {
                facadeSection.querySelector('.remove-section-btn').addEventListener('click', function() {
                    if (confirm('Remove this fa√ßade?')) {
                        document.getElementById(facadeId).remove();
                        renumberFacades();
                        triggerAutoSave();
                    }
                });
                
                document.getElementById('addFacadeBtn').textContent = '‚ûï Add Another Fa√ßade';
            }
            
            setupPhotoButtons();
            updateAllRunningHeaders();
        }
        
        function renumberFacades() {
            const facades = document.querySelectorAll('.facade-section');
            facadeCounter = facades.length;
            
            const addBtn = document.getElementById('addFacadeBtn');
            if (addBtn) {
                addBtn.textContent = facadeCounter > 1 ? '‚ûï Add Another Fa√ßade' : '‚ûï Add Fa√ßade';
            }
            
            facades.forEach(function(facade, index) {
                const num = index + 1;
                const header = facade.querySelector('.section-header h2');
                if (header) {
                    header.textContent = 'C.' + num + ': Fa√ßade ' + num;
                }
                
                const removeBtn = facade.querySelector('.remove-section-btn');
                if (num === 1 && removeBtn) {
                    removeBtn.style.display = 'none';
                } else if (num > 1 && removeBtn) {
                    removeBtn.style.display = '';
                }
            });
        }
    </script>
</body>
</html>
